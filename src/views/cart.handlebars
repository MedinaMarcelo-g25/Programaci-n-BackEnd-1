<div class="container">
    <h2>Mi Carrito</h2>
    <div id="cartContainer" class="mt-4">
        <p>Cargando...</p>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', loadCart);

async function loadCart() {
    try {
        const response = await fetch('/api/cart', {
            credentials: 'same-origin'
        });

        if (!response.ok) {
            throw new Error('Error al cargar el carrito');
        }

        const data = await response.json();
        const cart = data.cart;

        if (!cart || !cart.products || cart.products.length === 0) {
            document.getElementById('cartContainer').innerHTML = '<p>No hay productos en el carrito</p>';
            return;
        }

        let total = 0;
        let html = '<div class="table-responsive"><table class="table">';
        html += '<thead><tr><th>Producto</th><th>Cantidad</th><th>Precio</th><th>Subtotal</th></tr></thead><tbody>';

        cart.products.forEach(item => {
            const subtotal = item.quantity * item.product.price;
            total += subtotal;
            html += `
                <tr>
                    <td>${item.product.title}</td>
                    <td>${item.quantity}</td>
                    <td>$${item.product.price}</td>
                    <td>$${subtotal}</td>
                </tr>
            `;
        });

        html += `
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="3" class="text-end"><strong>Total:</strong></td>
                    <td>$${total}</td>
                </tr>
            </tfoot>
            </table></div>
            <button onclick="checkout()" class="btn btn-success mt-3">Finalizar Compra</button>
        `;

        document.getElementById('cartContainer').innerHTML = html;
    } catch (error) {
        console.error('Error:', error);
        document.getElementById('cartContainer').innerHTML = 
            '<div class="alert alert-danger">Error al cargar el carrito</div>';
    }
}

async function checkout() {
    try {
        const response = await fetch('/api/cart/checkout', {
            method: 'POST',
            credentials: 'same-origin'
        });

        const data = await response.json();

        if (response.ok) {
            alert('Â¡Compra finalizada! Orden: ' + data.orderId);
            window.location.reload();
        } else {
            throw new Error(data.message || 'Error al finalizar la compra');
        }
    } catch (error) {
        console.error('Error:', error);
        alert(error.message);
    }
}
</script>